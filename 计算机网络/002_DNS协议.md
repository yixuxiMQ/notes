# DNS协议

# 一、DNS是什么？

1. DNS（Domain Names System），域名系统，是进行域名和与之相对应的 IP 地址进行转换的服务器，简单来讲，`DNS`相当于一个翻译官，负责将域名翻译成`ip`地址；

2. DNS 协议是一个应用层协议，它建立在 `UDP` 或 `TCP` 协议之上，默认使用 `53` 号端口。该协议的功能就是将人类可读的域名 (www.baidu.com) 转换为机器可读的 IP 地址 (192.168.1.1)；

3. DNS协议默认通过 `UDP` 协议进行通讯，但是由于广域网中不适合传输过大的 `UDP` 数据包，因此规定当报文长度超过了 `512` 字节时，应转换为使用 `TCP` 协议进行数据传输。所以，`DNS` 协议是少有的既可以用 `UDP` 协议，又可以用 `TCP` 协议作为底层协议的应用层协议。

4. 域名：

   ![](https://tva1.sinaimg.cn/large/e6c9d24ely1h2euydof1oj20jj09bjrv.jpg)

   ![](https://tva1.sinaimg.cn/large/e6c9d24ely1h2euzgwicyj20sp0a7js6.jpg)

   ![](https://tva1.sinaimg.cn/large/e6c9d24ely1h2ev2npks9j21hi0b2abt.jpg)

# 二、DNS查询方式？

1. 递归查询：

   如果主机所询问的本地域名服务器不知道被查询的域名的IP地址，那么本地域名服务器就以DNS客户的身份，向其它根域名服务器继续发出查询请求报文(即替主机继续查询)，而不是让主机自己进行下一步查询。

   **简言之：我会给你答案。**

   ![](https://tva1.sinaimg.cn/large/e6c9d24ely1h2ev5r4nr6j20hi0f7wf6.jpg)

2. 迭代查询：

   当根域名服务器收到本地域名服务器发出的迭代查询请求报文时，要么给出所要查询的IP地址，要么告诉本地服务器下一步应当向哪一个域名服务器进行查询，然后让本地服务器进行后续的查询。根域名服务器通常是把自己知道的顶级域名服务器的IP地址告诉本地域名服务器，让本地域名服务器再向顶级域名服务器查询。

   **简言之：我知道会告诉你，不知道会帮你打听，告诉你谁知道。**

   ​			![](https://tva1.sinaimg.cn/large/e6c9d24ely1h2ev6zngcrj20i60fwdgn.jpg)

# 三、域名缓存？

1. **在域名服务器解析的时候，会使用缓存来保存域名和对应IP的映射。**
2. DNS的缓存方式：
   1. 浏览器缓存：浏览器在获取网站域名的实际 IP 地址后会对其进行缓存，减少网络请求的损耗。
   2. 操作系统缓存：操作系统的缓存其实是用户自己配置的 `hosts` 文件。



# 四、DNS查询过程？

1. 首先搜索浏览器的 DNS 缓存，缓存中维护一张域名与 IP 地址的对应表
2. 若没有命中，则继续搜索操作系统的 DNS 缓存
3. 若仍然没有命中，则操作系统将域名发送至`本地域名服务器`，本地域名服务器采用递归查询自己的 DNS 缓存，查找成功则返回结果
4. 若本地域名服务器的 DNS 缓存没有命中，则本地域名服务器向`上级域名服务器`进行迭代查询

   1. 首先`本地域名服务器`向`根域名服务器`发起请求，`根域名服务器`返回`顶级域名服务器`的IP地址给本地服务器
   2. 本地域名服务器拿到这个`顶级域名服务器`的IP地址后，就向其发起请求，`顶级域名服务器`会返回`权限域名服务器`的IP地址
   3. `本地域名服务器`根据`权限域名服务器`的IP地址向其发起请求，`权限域名服务器`最终将目标域名IP地址返回给本地域名服务器

5. 本地域名服务器将得到的 IP 地址返回给`操作系统`，同时`本地域名服务器`将 IP 地址缓存起来
6. 操作系统将 IP 地址返回给浏览器，同时操作系统也将 IP 地址缓存起
7. 最后，浏览器就得到了域名对应的 IP 地址，并将 IP 地址缓存起

