# 第一篇 框架设计概览

-----

## 第一章 权衡的艺术

### 1.1 命令式和声明式

#### 1. 什么是命令式？

> 自然语言描述能够与代码产生一一对应的关系，代码本身描述的是“做事的过程”

命令式关注的是“过程”，什么是关注过程？就是使用代码描述所要实现的事情。

```js
// 文字描述
第一步：获取 id 为 app 的 div 标签
第二步：它的文本内容为 hello world
第三步：为其绑定点击事件
第四步：当点击时弹出提示：ok”

// 代码实现
const oApp = document.getElementById("app");
oApp.innerText = "hello world";
oApp.addEventListener("click",()=>{
  alert("OK")
})

从上面的代码可以分步看出：获取元素、设置文本内容、绑定点击事件、触发事件
```

#### 2. 什么是声明式？

声明式关注的是“结果”，所谓的结果，就是不管这个东西是如何实现的，只看它展现出来的样子。就是将内部操作都封装好，只需要展示你所需要的内容，也就是达到你想要的结果。

```html
<div @click="() => alert('ok')">hello world</div>
```

### 1.2 性能与可维护性的权衡

> 声明式代码的性能不优于命令式代码的性能。

#### 性能和可维护性之间的关系？

当想要修改页面内容的时候，例如要修改`div`标签中的内容，使用命令式代码性能是最高效的，是因为我们明确的知道哪里的内容发生了变化，只需要通过获取元素设置新的内容就可以。但是当使用声明式代码的时候，由于声明式代码拥有较好的封装性，需要让框架自己去比较发生变化的地方，这样不仅要耗费和命令式代码一样的直接修改内容造成的性能消耗，还要消耗找出差异的性能消耗，这样就理解为什么声明式代码的性能不优于命令式代码。

```tex
命令式代码小号的性能 = 直接修改内容消耗的性能
声明式代码消耗的性能 = 直接修改内容小号的性能 + 找出差异消耗的性能
```

从上面的公式看出，无论如何命令式代码消耗的性能都小于等于声明式代码消耗的性能，那么为什么还要选择声明式代码呢？原因就在于声明式代码的可维护性更强，让用户不必将大量的精力用在手动实现DOM元素的创建、更新、删除等工作。这样就体现出了性能要与可维护性之间权衡。

### 1.3 虚拟DOM性能的讨论

#### 虚拟DOM需要解决哪些问题？

JavaScript原生操作DOM的性能是最高的，但是可维护性不强，当项目形成一定规模，需要耗费巨大的精力。那么使用声明式框架又要多消耗“找出差异”的性能，所以让“找出差异”消耗的性能越小，框架整体的性能就越优。

虚拟DOM就是为了让用户不需要付出太大精力，又能保证应用程序的性能下限。

### 1.4 运行时和编译时

#### 1. 运行时

纯运行时框架，会提供一个`Render`函数，用户只需要提供一个树形结构的数据对象当做`Render`函数的参数，Render函数会递归的将数据渲染成真实DOM元素。

```js
const data = {
  tag: 'div',
  children: [
    { tag: 'span', children: 'hello world' },
    { tag: 'span', children: 'hello Vue3' }
  ]
};

function Render(data, root){
  const el = document.createElement(data.tag);
  if(typeof data.children === 'string') {
    const text = document.createTextNode(data.children);
    el.appendChild(text);
  }else if(data.children) {
    data.children.forEach(child => Render(child, el))
  }
  root.appendChild(el);
}
```

优点：只需要提供树形结构的数据对象，不需要学习额外的知识。

缺点：手写树形结构的数据对象太过于麻烦，不直观。

#### 2. 运行时+编译时

针对纯运行时的缺点，我们想能不能用HTML标签的方式描述树形结构对象，这时候就需要编译时了。

编译时会提供一个`Compiler`的程序，这个程序会将HTML字符串编译成树形结构的数据对象，那么结合`Render`函数，就能实现一个`运行时+编译时`的框架。

```js
const html = `
	<div>
		<span>Hello World</span>
	</div>
`

const data = Compiler(html);	// 将HTML字符串编译成Render函数需要的树形结构的数据对象
Render(data, document.body);	// Render函数进行渲染
```

这样就既支持用户直接提供树形结构的数据对象，又可以支持使用HTML标签字符串。

> 框架是纯编译时的，那么它也可以分析用户提供的内容。由于不需要任何运行时，而是直接编译成可执行的 JavaScript 代码，因此性能可能会更好，但是这种做法有损灵活性，即用户提供的内容必须编译后才能用。



#### 3. 编译时

纯编译时，就是直接将HTML字符串编译成命令式代码，这样就只需要一个Compiler函数就够了，不需要渲染函数。

> 纯编译时的，那么它也可以分析用户提供的内容。由于不需要任何运行时，而是直接编译成可执行的 JavaScript 代码，因此性能可能会更好，但是这种做法有损灵活性，即用户提供的内容必须编译后才能用。

------

